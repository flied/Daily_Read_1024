name: Handle New Issue

on:
  issues:
    types: [opened] # å½“æœ‰æ–° Issue åˆ›å»ºæ—¶è§¦å‘
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹æŒ‰é’®è§¦å‘

permissions:
  contents: write
  issues: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. å‘é€é€šçŸ¥åˆ° Telegram
      - name: Notify Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          # æ¶ˆæ¯æ ¼å¼ï¼šæ ‡é¢˜åŠ ç²—ï¼Œæ¢è¡Œæ˜¾ç¤ºè¯„è®ºï¼Œæœ€åé™„å¸¦ GitHub é“¾æ¥
          message: |
            *${{ github.event.issue.title }}*
            
            ${{ github.event.issue.body }}
            
            [View on GitHub](${{ github.event.issue.html_url }})

      # 2. è‡ªåŠ¨ç”Ÿæˆ README (è¡¨æ ¼æ ¼å¼)
      - name: Update README
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            // è·å–æ‰€æœ‰ open çš„ issueï¼ŒæŒ‰åˆ›å»ºæ—¶é—´å€’åº
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: 100
            });

            // ç”Ÿæˆ Markdown å¤´éƒ¨
            let content = "# ğŸ“š My Reading List\n\nè‡ªåŠ¨æ”¶é›†è‡ªæµè§ˆå™¨ï¼Œæ¯æ—¥æ›´æ–°ã€‚\n\n";
            
            // è¡¨æ ¼å¤´
            content += "| æ—¥æœŸ | æ ‡é¢˜ | URL | è¯„è®º | æ ‡ç­¾ |\n";
            content += "| :--- | :--- | :--- | :--- | :--- |\n";

            issues.forEach(issue => {
              const date = new Date(issue.created_at).toISOString().split('T')[0];
              
              // 1. å¤„ç†æ ‡é¢˜ï¼šç§»é™¤å¯èƒ½å­˜åœ¨çš„ Markdown é“¾æ¥è¯­æ³•ï¼Œåªä¿ç•™çº¯æ–‡æœ¬
              // ç®€å•å¤„ç†ï¼šå¦‚æœæ ‡é¢˜é‡Œæœ‰ [xxx](url)ï¼Œåªå– xxxã€‚è¿™é‡Œå‡è®¾æ ‡é¢˜å°±æ˜¯çº¯æ–‡æœ¬ï¼Œåªæ˜¯é¢„é˜²ä¸‡ä¸€ã€‚
              const title = issue.title.replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1').trim();

              // 2. å¤„ç†æ ‡ç­¾
              const tags = issue.labels.map(l => `\`${l.name}\``).join(' ');

              // 3. è§£æ Bodyï¼Œå°è¯•åˆ†ç¦» URL å’Œ è¯„è®º
              // å‡è®¾ body çš„æ ¼å¼ä¸­åŒ…å« URLã€‚
              let url = issue.html_url; // é»˜è®¤è·³å› issue
              let comment = "";
              
              if (issue.body) {
                // æ­£åˆ™æå– body ä¸­çš„ http/https é“¾æ¥
                const urlMatch = issue.body.match(/(https?:\/\/[^\s\n]+)/);
                if (urlMatch) {
                   url = urlMatch[0]; // æå–åˆ°çš„ç¬¬ä¸€ä¸ªé“¾æ¥ä½œä¸ºåŸæ–‡é“¾æ¥
                   // è¯„è®ºå°±æ˜¯æŠŠé“¾æ¥å»æ‰åçš„å‰©ä½™å†…å®¹
                   comment = issue.body.replace(url, '').trim(); 
                } else {
                   // å¦‚æœ body é‡Œæ²¡æœ‰é“¾æ¥ï¼Œæ•´ä¸ª body éƒ½æ˜¯è¯„è®º
                   comment = issue.body.trim();
                }
                
                // æ¸…ç†è¯„è®ºä¸­çš„æ¢è¡Œç¬¦ï¼Œå› ä¸ºè¡¨æ ¼ä¸æ”¯æŒæ¢è¡Œï¼Œç”¨ <br> æˆ–è€…ç©ºæ ¼ä»£æ›¿
                comment = comment.replace(/[\r\n]+/g, ' ').trim();
              }
              
              // 4. æ‹¼æ¥è¡¨æ ¼è¡Œ
              // è¿™é‡Œçš„ URL åˆ—å¦‚æœä¸å¸Œæœ›å¤ªé•¿ï¼Œå¯ä»¥å†™æˆ [Link](url) æˆ–è€…ç›´æ¥æ”¾ url
              content += `| ${date} | ${title} | ${url} | ${comment} | ${tags} |\n`;
            });

            fs.writeFileSync('README.md', content);
