name: Handle New Issue

on:
  issues:
    types: [opened] # å½“æœ‰æ–° Issue åˆ›å»ºæ—¶è§¦å‘
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹æŒ‰é’®è§¦å‘

permissions:
  contents: write
  issues: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. è§£æå†…å®¹å¹¶å‘é€é€šçŸ¥åˆ° Telegram
      - name: Send Custom Telegram Notification
        uses: actions/github-script@v6
        env:
          TG_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";
            
            // --- 1. æå–åŸå§‹ URL ---
            const urlMatch = body.match(/URL:\s*(https?:\/\/[^\s\n]+)/);
            const originalUrl = (urlMatch && urlMatch[1]) ? urlMatch[1] : issue.html_url; 
            
            // --- 2. æå–è¯„è®º (ä¿ç•™æ¢è¡Œ) ---
            const commentMatch = body.match(/Comment:\s*([\s\S]*)/);
            let comment = (commentMatch && commentMatch[1]) ? commentMatch[1] : "";
            // ä¿ç•™åŸå§‹æ¢è¡Œï¼ŒTelegramæ”¯æŒ\næ¢è¡Œ
            
            // --- 3. å¤„ç†æ ‡ç­¾ (ç¡®ä¿Telegram hashtagå¯ç‚¹å‡») ---
            // Telegram hashtagè§„åˆ™ï¼š#åé¢è·Ÿå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€ä¸­æ–‡ç­‰ï¼Œé‡åˆ°ç©ºæ ¼å°±ç»“æŸ
            // ç­–ç•¥ï¼šå°†Labelå†…éƒ¨çš„ç©ºæ ¼æ›¿æ¢ä¸ºä¸‹åˆ’çº¿ï¼Œæ ‡ç­¾ä¹‹é—´ç”¨ç©ºæ ¼åˆ†éš”
            const tags = issue.labels.map(l => {
                // æ¸…ç†æ ‡ç­¾åï¼šä¿ç•™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€ä¸­æ–‡ï¼Œå°†å…¶ä»–å­—ç¬¦ï¼ˆåŒ…æ‹¬ç©ºæ ¼ï¼‰æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
                let safeName = l.name.trim()
                    .replace(/[^\w\u4e00-\u9fa5]/g, '_')  // å°†éå­—æ¯æ•°å­—ä¸‹åˆ’çº¿ä¸­æ–‡çš„å­—ç¬¦æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
                    .replace(/_+/g, '_')                   // å°†å¤šä¸ªè¿ç»­ä¸‹åˆ’çº¿åˆå¹¶ä¸ºä¸€ä¸ª
                    .replace(/^_+|_+$/g, '');              // ç§»é™¤å¼€å¤´å’Œç»“å°¾çš„ä¸‹åˆ’çº¿
                // ç¡®ä¿æ ‡ç­¾åä¸ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼
                if (!safeName) safeName = 'tag';
                return `#${safeName}`;
            }).join(' '); // æ ‡ç­¾ä¹‹é—´ç”¨ç©ºæ ¼åˆ†éš”ï¼ŒTelegramä¼šè‡ªåŠ¨è¯†åˆ«æ¯ä¸ªç‹¬ç«‹çš„#wordä¸ºhashtag

            // --- 4. æ„å»ºæ¶ˆæ¯ ---
            // ä½¿ç”¨æ•°ç»„è¿‡æ»¤ç©ºå†…å®¹ï¼Œç„¶åç”¨å•æ¢è¡Œç¬¦è¿æ¥ï¼Œå»é™¤ä¸­é—´ç©ºè¡Œ
            const messageParts = [];
            
            if (comment) messageParts.push(comment); // æœ‰è¯„è®ºæ‰æ”¾
            if (tags) messageParts.push(tags);       // æœ‰æ ‡ç­¾æ‰æ”¾
            messageParts.push(originalUrl);          // URL å¿…æ”¾

            const message = messageParts.join('\n'); // ä½¿ç”¨å•æ¢è¡Œç¬¦è¿æ¥

            // --- 5. å‘é€ ---
            const token = process.env.TG_BOT_TOKEN;
            const chatId = process.env.TG_CHAT_ID;
            
            if (!token || !chatId) return;

            try {
                await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        disable_web_page_preview: false 
                    })
                });
            } catch (error) {
                console.error("Failed to send Telegram notification:", error);
            }

      # 2. è‡ªåŠ¨ç”Ÿæˆ README (è¡¨æ ¼æ ¼å¼)
      - name: Update README
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            // è·å–æ‰€æœ‰ open çš„ issueï¼ŒæŒ‰åˆ›å»ºæ—¶é—´å€’åº
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: 100
            });

            // ç”Ÿæˆ Markdown å¤´éƒ¨
            let content = "# ğŸ“š My Reading List\n\nè‡ªåŠ¨æ”¶é›†è‡ªæµè§ˆå™¨ï¼Œæ¯æ—¥æ›´æ–°ã€‚\n\n";
            
            // è¡¨æ ¼å¤´ï¼šæ—¥æœŸ | æ ‡é¢˜ | è¯„è®º | æ ‡ç­¾
            content += "| æ—¥æœŸ | æ ‡é¢˜ | è¯„è®º | æ ‡ç­¾ |\n";
            content += "| :--- | :--- | :--- | :--- |\n";

            issues.forEach(issue => {
              const date = new Date(issue.created_at).toISOString().split('T')[0];
              const body = issue.body || "";

              // --- 1. è§£æåŸå§‹ URL ---
              // ä¼˜å…ˆä» Body ä¸­æå– URL: ...ï¼Œå¦‚æœæ²¡æœ‰åˆ™é™çº§ä½¿ç”¨ Issue é“¾æ¥
              const urlMatch = body.match(/URL:\s*(https?:\/\/[^\s\n]+)/);
              const url = (urlMatch && urlMatch[1]) ? urlMatch[1] : issue.html_url;

              // --- 2. è§£ææ ‡é¢˜ ---
              // ç§»é™¤æ ‡é¢˜ä¸­å¯èƒ½ç ´å Markdown è¡¨æ ¼çš„ç«–çº¿ |
              let titleText = issue.title.replace(/\|/g, '-').trim();
              // æ„å»º [æ ‡é¢˜](URL) æ ¼å¼
              const titleLink = `[${titleText}](${url})`;

              // --- 3. è§£æè¯„è®º (ä¿ç•™æ¢è¡Œï¼Œä½¿ç”¨HTMLæ¢è¡Œæ ‡ç­¾) ---
              const commentMatch = body.match(/Comment:\s*([\s\S]*)/);
              let comment = (commentMatch && commentMatch[1]) ? commentMatch[1] : "";
              // ä¿ç•™æ¢è¡Œï¼šå°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLçš„<br>æ ‡ç­¾ï¼ŒåŒæ—¶æ¸…ç†å¯èƒ½ç ´åè¡¨æ ¼çš„ç«–çº¿
              comment = comment.replace(/\|/g, '-').replace(/\r\n/g, '<br>').replace(/\n/g, '<br>').replace(/\r/g, '<br>');

              // --- 4. è§£ææ ‡ç­¾ ---
              // æ ¼å¼åŒ–ä¸º #Tag1 #Tag2
              const tags = issue.labels.map(l => `\`#${l.name}\``).join(' ');

              // --- 5. æ‹¼æ¥è¡¨æ ¼è¡Œ ---
              content += `| ${date} | ${titleLink} | ${comment} | ${tags} |\n`;
            });

            fs.writeFileSync('README.md', content);
      # 3. æäº¤ README çš„æ›´æ”¹ (è¿™æ˜¯ä¹‹å‰å¯èƒ½æ¼æ‰çš„)
      - name: Commit & Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–ï¼Œæœ‰å˜åŒ–åˆ™æäº¤
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update README with latest issues"
            git push
          fi
