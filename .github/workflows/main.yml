name: Handle New Issue

on:
  issues:
    types: [opened] # ÂΩìÊúâÊñ∞ Issue ÂàõÂª∫Êó∂Ëß¶Âèë
  workflow_dispatch: # ÂÖÅËÆ∏ÊâãÂä®ÁÇπÊåâÈíÆËß¶Âèë

permissions:
  contents: write
  issues: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. ÂèëÈÄÅÈÄöÁü•Âà∞ Telegram
      - name: Notify Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          # Ê∂àÊÅØÊ†ºÂºèÔºöÊ†áÈ¢òÂä†Á≤óÔºåÊç¢Ë°åÊòæÁ§∫ËØÑËÆ∫ÔºåÊúÄÂêéÈôÑÂ∏¶ GitHub ÈìæÊé•
          message: |
            *${{ github.event.issue.title }}*
            
            ${{ github.event.issue.body }}
            
            [View on GitHub](${{ github.event.issue.html_url }})

      # 2. Ëá™Âä®ÁîüÊàê README (ÊåâÊó•ÊúüÂàÜÁªÑ)
      - name: Update README
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            // Ëé∑ÂèñÊâÄÊúâ open ÁöÑ issueÔºåÊåâÂàõÂª∫Êó∂Èó¥ÂÄíÂ∫è
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: 100
            });

            // ÊåâÊó•ÊúüÂàÜÁªÑ
            const grouped = {};
            issues.forEach(issue => {
              const date = new Date(issue.created_at).toISOString().split('T')[0];
              if (!grouped[date]) grouped[date] = [];
              grouped[date].push(issue);
            });

            // ÁîüÊàê Markdown
            let content = "# üìö My Reading List\n\nËá™Âä®Êî∂ÈõÜËá™ÊµèËßàÂô®ÔºåÊØèÊó•Êõ¥Êñ∞„ÄÇ\n\n";
            
            for (const date in grouped) {
              content += `### ${date}\n`;
              grouped[date].forEach(issue => {
                const tags = issue.labels.map(l => `\`${l.name}\``).join(' ');
                // Â§ÑÁêÜÊç¢Ë°åÔºåËÆ©ÂºïÁî®Êõ¥Â•ΩÁúã
                let body = issue.body ? issue.body.replace(/\r\n/g, '\n').replace(/\n/g, '\n  > ') : '';
                if(body) body = `\n  > ${body}`;
                
                content += `- [${issue.title}](${issue.html_url}) ${tags}${body}\n`;
              });
              content += "\n";
            }

            fs.writeFileSync('README.md', content);

      # 3. Êèê‰∫§ README ÁöÑÊõ¥Êîπ
      - name: Commit & Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          git commit -m "Auto-update README with latest issues" || echo "No changes"
          git push
