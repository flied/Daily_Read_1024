name: Handle New Issue

on:
  issues:
    types: [opened] # å½“æœ‰æ–° Issue åˆ›å»ºæ—¶è§¦å‘
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹æŒ‰é’®è§¦å‘

permissions:
  contents: write
  issues: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. å‘é€é€šçŸ¥åˆ° Telegram
            # 1. è§£æå†…å®¹å¹¶å‘é€é€šçŸ¥åˆ° Telegram
      - name: Send Custom Telegram Notification
        uses: actions/github-script@v6
        env:
          TG_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        with:
          script: |
            // 1. è·å– Issue æ•°æ®
            const issue = context.payload.issue;
            const body = issue.body || "";
            
            // 2. è§£æ Body å†…å®¹ (æå– Comment å’Œ åŸå§‹ URL)
            // ä¹¦ç­¾æ ¼å¼: Title: ... \n URL: ... \n\n Comment: ...
            
            // æå–åŸå§‹ URL
            const urlMatch = body.match(/URL:\s*(https?:\/\/[^\s\n]+)/);
            const originalUrl = (urlMatch && urlMatch[1]) ? urlMatch[1] : issue.html_url; // æ²¡æŠ“åˆ°å°±ç”¨Issueé“¾æ¥å…œåº•
            
            // æå–è¯„è®º
            const commentMatch = body.match(/Comment:\s*([\s\S]*)/);
            let comment = (commentMatch && commentMatch[1]) ? commentMatch[1].trim() : "No comment";
            // å¦‚æœè¯„è®ºä¸ºç©ºï¼Œæ˜¾ç¤º "RT" (ReTweetçš„æ„æ€) æˆ–è€…ä½ å–œæ¬¢çš„å ä½ç¬¦
            if(!comment) comment = "RT";

            // 3. å¤„ç†æ ‡ç­¾ (è½¬æ¢ä¸º Hashtag æ ¼å¼)
            // ä¾‹å¦‚: ['tag1', 'tag2'] -> "#tag1 #tag2"
            const tags = issue.labels.map(l => `#${l.name}`).join(' ');

            // 4. æ„å»º Telegram æ¶ˆæ¯æ–‡æœ¬
            // ç¬¬ä¸€æ®µ: Comment
            // ç¬¬äºŒæ®µ: #Labels
            // ç¬¬ä¸‰æ®µ: Original URL
            const message = `${comment}\n\n${tags}\n\n${originalUrl}`;

            // 5. è°ƒç”¨ Telegram API å‘é€
            const token = process.env.TG_BOT_TOKEN;
            const chatId = process.env.TG_CHAT_ID;
            
            if (!token || !chatId) {
                console.log("Telegram secrets not found, skipping notification.");
                return;
            }

            try {
                await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        disable_web_page_preview: false // è®¾ä¸º false ä»¥ä¾¿æ˜¾ç¤ºç½‘é¡µé¢„è§ˆ
                    })
                });
                console.log("Telegram notification sent successfully.");
            } catch (error) {
                console.error("Failed to send Telegram notification:", error);
            }

      # 2. è‡ªåŠ¨ç”Ÿæˆ README (è¡¨æ ¼æ ¼å¼)

      - name: Update README
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            // è·å–æ‰€æœ‰ open çš„ issueï¼ŒæŒ‰åˆ›å»ºæ—¶é—´å€’åº
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: 100
            });

            // ç”Ÿæˆ Markdown å¤´éƒ¨
            let content = "# ğŸ“š My Reading List\n\nè‡ªåŠ¨æ”¶é›†è‡ªæµè§ˆå™¨ï¼Œæ¯æ—¥æ›´æ–°ã€‚\n\n";
            content += "| æ—¥æœŸ | æ ‡é¢˜ | é“¾æ¥ | è¯„è®º | æ ‡ç­¾ |\n";
            content += "| :--- | :--- | :--- | :--- | :--- |\n";

            issues.forEach(issue => {
              const date = new Date(issue.created_at).toISOString().split('T')[0];
              
              // 1. å¤„ç†æ ‡é¢˜ (ç§»é™¤å¯èƒ½å­˜åœ¨çš„ Markdown é“¾æ¥è¯­æ³•ï¼Œé˜²æ­¢ç ´åè¡¨æ ¼)
              let title = issue.title.replace(/\|/g, '-').trim();

              // 2. å¤„ç†æ ‡ç­¾
              const tags = issue.labels.map(l => `\`${l.name}\``).join(' ');

              // 3. è§£æ Body (å…³é”®ä¿®æ”¹éƒ¨åˆ†)
              let url = issue.html_url; // é»˜è®¤ä¸º Issue åœ°å€ä½œä¸ºä¿åº•
              let comment = "";
              const body = issue.body || "";

              // å°è¯•è§£æä¹¦ç­¾å‘é€çš„æ ‡å‡†æ ¼å¼
              // æ ¼å¼: Title: ... \n URL: ... \n\n Comment: ...
              const urlMatch = body.match(/URL:\s*(https?:\/\/[^\s\n]+)/);
              const commentMatch = body.match(/Comment:\s*([\s\S]*)/); // åŒ¹é… Comment: åé¢çš„æ‰€æœ‰å†…å®¹

              if (urlMatch && urlMatch[1]) {
                  url = urlMatch[1];
              }
              
              if (commentMatch && commentMatch[1]) {
                  comment = commentMatch[1].trim();
              } else if (!urlMatch) {
                  // å¦‚æœä¸æ˜¯æ ‡å‡†æ ¼å¼ï¼ˆæ¯”å¦‚æ‰‹åŠ¨æçš„ Issueï¼‰ï¼Œå°±æŠŠæ•´ä¸ª body å½“è¯„è®º
                  comment = body;
              }

              // 4. æ¸…ç†æ•°æ®ä»¥é€‚é… Markdown è¡¨æ ¼
              // å°† URL è½¬æ¢ä¸º Markdown é“¾æ¥èŠ‚çœç©ºé—´
              const urlLink = `[Link](${url})`; 
              // æ¸…ç†è¯„è®ºä¸­çš„æ¢è¡Œç¬¦å’Œç®¡é“ç¬¦
              comment = comment.replace(/[\r\n]+/g, ' ').replace(/\|/g, '-').trim();
              
              content += `| ${date} | ${title} | ${urlLink} | ${comment} | ${tags} |\n`;
            });

            fs.writeFileSync('README.md', content);

      # 3. æäº¤ README çš„æ›´æ”¹ (è¿™æ˜¯ä¹‹å‰å¯èƒ½æ¼æ‰çš„)
      - name: Commit & Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–ï¼Œæœ‰å˜åŒ–åˆ™æäº¤
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update README with latest issues"
            git push
          fi
